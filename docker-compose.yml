services:
    nginx:
        image: nginx:alpine
        container_name: nginx
        ports:
            - "80:80"
        volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf:ro
        depends_on:
            oauth2-proxy:
                condition: service_healthy
            api:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost/health"]
            interval: 5s
            timeout: 10s
            retries: 3
            start_period: 2s

    oauth2-proxy:
        container_name: oauth2-proxy
        image: quay.io/oauth2-proxy/oauth2-proxy:v7.11.0-alpine
        command:
            - --upstream=http://api:3000
            - --reverse-proxy=true
            - --cookie-httponly=true
            - --request-logging=true
            - --auth-logging=true
            - --standard-logging=true
            - --session-store-type=redis
            - --redis-connection-url=redis://redis:6379/2
            - --skip-provider-button
            - --pass-access-token=false
            - --pass-authorization-header=false
            - --set-xauthrequest=true
        entrypoint:
            - oauth2-proxy
        env_file:
            - .env.oauthproxy
        ports:
            - 8000:8000
        depends_on:
            redis:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/ready"]
            interval: 5s
            timeout: 10s
            retries: 3
            start_period: 2s

    redis:
        image: redis:7.0
        container_name: redis
        expose:
            - 6379
        volumes:
            - redis_data:/data
        command:
            ["redis-server", "--appendonly", "yes", "--save", "60", "10000"]
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 2s

    postgres:
        container_name: postgres
        image: postgres:18
        env_file:
            - .env.postgres
        ports:
            - 5432:5432
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 2s

    migrations:
        build: .
        container_name: migrations
        command: ["/app/migrations"]
        env_file: 
            - .env
        depends_on:
            postgres:
                condition: service_healthy

    api:
        build: .
        expose:
            - 3000
        container_name: api
        command: ["/app/auth_service"]
        ports:
            - 3000:3000
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
            interval: 5s
            timeout: 10s
            retries: 3
            start_period: 2s
        env_file:
            - .env
        depends_on:
            migrations:
                condition: service_completed_successfully
            postgres:
                condition: service_healthy

volumes:
    redis_data:
